<!doctype html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>dvara: A Mongo Proxy</title>
    <link rel="apple-touch-icon" sizes="57x57" href="/img/favicon/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/img/favicon/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/img/favicon/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/img/favicon/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/img/favicon/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/img/favicon/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/img/favicon/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/img/favicon/apple-touch-icon-180x180.png">
    <meta name="apple-mobile-web-app-title" content="Parse">
    <link rel="icon" type="image/png" href="/img/favicon/favicon-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/img/favicon/favicon-160x160.png" sizes="160x160">
    <link rel="icon" type="image/png" href="/img/favicon/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/img/favicon/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="/img/favicon/favicon-32x32.png" sizes="32x32">
    <meta name="msapplication-TileColor" content="#5298fc">
    <meta name="msapplication-TileImage" content="/img/favicon/apple-touch-icon-144x144.png">
    <meta name="application-name" content="Parse">
    <meta name="theme-color" content="#5298fc">
    <!-- CSS -->
    <!-- build:css -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.5.0/styles/default.min.css">
    <link href="/css/blog.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" rel="stylesheet" />
    <!-- endbuild -->
    <!--[if lte IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/classlist/2014.01.31/classList.min.js"></script>
    <![endif]-->
    <script src="//cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/anchor-js/3.2.2/anchor.js"></script>
    <!--[if lt IE 8]>
    <link rel="stylesheet" type="text/css" href="/stylesheets/ie7.css" />
    <![endif]-->
    <!--[if IE 8]>
    <link rel="stylesheet" type="text/css" href="/stylesheets/ie8.css" />
    <![endif]-->
    <!--[if lt IE 10]>
    <link rel="stylesheet" type="text/css" href="/stylesheets/ie89.css" />
    <![endif]-->
    <script>if(Function('/*@cc_on return document.documentMode===10@*/')()){document.documentElement.className+=' ie10';}</script>
    <meta name="csrf-param" content="authenticity_token">
    <meta name="csrf-token" content="KxDoKysxiXDIRV8VXwDYlQStDGzjbGZ24y6ZgQLYAsE=">
    <meta name="description" content="The best place to stay up-to-date with the latest Parse news and events.
">
    <meta name="keywords" content="backend, mobile, development, server, code">
    <meta property="fb:app_id" content="361736430535656">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Parse">
    <meta property="og:image" content="http://blog.parseplatform.org//assets/images/social.jpg">
    <meta property="og:description" content="The best place to stay up-to-date with the latest Parse news and events.
">
    <meta property="og:url" content="http://blog.parseplatform.org//learn/engineering/dvara/">
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body class="pure p_docs p_docs_index  user_logged_in">
<div class="site__wrapper">
    <div class="site__content">
        <div class="content__wrapper">
            <header class="site__header site__header--white">
    <div class="container">
        <a href="/" class="header-logo">
            <span class="hidden">Parse</span>
            <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
            	 viewBox="0 0 152 60" style="enable-background:new 0 0 152 60;" xml:space="preserve">
            <g>
            	<path class="line one" d="M23.072,39.678c-0.011,3.348-2.395,4.615-4.909,4.615c-2.851,0-4.541-1.701-4.541-4.357
            		c0-2.964,2.031-4.667,5.35-4.725h13.611c6.428,0.079,10.137-5.391,10.137-9.953c0-4.598-3.485-9.598-9.622-9.842
            		c-6.083-0.242-9.99,5.281-9.99,11.167v3.863"/>
            	<path class="line two" d="M23.072,39.678c-0.011,3.348-2.395,4.615-4.909,4.615c-2.851,0-4.541-1.701-4.541-4.357
            		c0-2.964,2.031-4.667,5.35-4.725h13.611c6.428,0.079,10.137-5.391,10.137-9.953c0-4.598-3.485-9.598-9.622-9.842
            		c-6.083-0.242-9.99,5.281-9.99,11.167v3.863"/>
            	<path class="line three" d="M23.072,39.678c-0.011,3.348-2.395,4.615-4.909,4.615c-2.851,0-4.541-1.701-4.541-4.357
            		c0-2.964,2.031-4.667,5.35-4.725h13.611c6.428,0.079,10.137-5.391,10.137-9.953c0-4.598-3.485-9.598-9.622-9.842
            		c-6.083-0.242-9.99,5.281-9.99,11.167v3.863"/>
            	<path class="st1" d="M151.88,31.106c0-4.561-2.575-7.835-7.173-7.872c-5.665-0.037-9.197,4.12-9.197,10.484v0.11
            		c0,6.033,3.863,9.601,9.601,9.601c1.839,0,4.083-0.405,5.739-1.177v-3.568c-1.839,0.956-3.752,1.398-5.408,1.398
            		c-3.568,0-6.07-1.803-6.18-5.959h12.36C151.807,33.056,151.88,32.026,151.88,31.106z M148.312,31.07h-8.829
            		c0.625-3.053,2.354-4.745,4.966-4.745c2.575,0,3.863,1.729,3.863,4.561V31.07z"/>
            	<path class="st1" d="M125.725,34.712l0.405,0.147c2.869,1.03,3.531,1.655,3.531,2.906c0,1.471-0.993,2.428-3.458,2.428
            		c-1.986,0-4.12-0.662-6.364-1.692v3.752c1.803,0.699,4.12,1.177,6.364,1.177c4.819,0,7.21-2.428,7.21-5.812
            		c0-2.943-1.471-4.525-5.408-5.959l-0.405-0.147c-3.127-1.14-3.752-1.655-3.752-2.869c0-1.361,0.956-2.281,3.237-2.281
            		c1.839,0,3.642,0.589,5.408,1.435v-3.531c-1.582-0.625-3.348-1.03-5.26-1.03c-4.598,0-7.1,2.575-7.1,5.886
            		C120.134,31.695,121.679,33.24,125.725,34.712"/>
            	<path class="st1" d="M110.863,29.892c1.288-2.023,3.09-3.016,5.26-3.016c0.773,0,1.508,0.11,2.17,0.331v-3.384
            		c-0.625-0.258-1.361-0.405-2.134-0.405c-2.281,0-4.01,1.03-5.518,3.09l-0.258-2.869h-3.164v19.386h3.642V29.892z"/>
            	<path class="st1" d="M96.481,23.197c-2.281,0-4.672,0.699-6.474,1.692v3.605c2.023-1.251,4.378-2.023,6.254-2.023
            		c2.612,0,3.679,1.14,3.679,3.274v1.619c-5.334,0.147-8.461,1.03-10.116,2.685c-1.177,1.14-1.692,2.685-1.692,4.267
            		c0,3.274,2.354,5.15,5.702,5.15c2.244,0,4.378-0.92,6.327-2.796l0.221,2.354h3.164V30.003
            		C103.544,25.405,101.263,23.197,96.481,23.197z M99.938,37.728c-1.471,1.619-3.2,2.722-5.297,2.722
            		c-1.729,0-2.833-0.883-2.833-2.428c0-2.281,1.876-3.642,8.13-3.826V37.728z"/>
            	<path class="st1" d="M77.609,17.643h-8.571v25.383h3.826v-8.314h4.745c5.923,0,9.491-3.164,9.491-8.498V26.14
            		C87.1,20.806,83.532,17.643,77.609,17.643z M83.311,26.214c0,3.421-1.986,5.04-5.444,5.04h-5.003V21.101h5.04
            		c3.421,0,5.408,1.619,5.408,5.04V26.214z"/>
            	<path class="st1" d="M27.838,2.192C12.204,2.192-0.12,14.589-0.12,30.15c0,15.597,12.323,27.958,27.958,27.958
            		c15.634,0,27.958-12.36,27.958-27.958C55.795,14.589,43.472,2.192,27.838,2.192z M32.473,36.955H18.752
            		c-1.986,0-3.164,1.214-3.164,3.017c0,1.582,1.067,2.722,2.612,2.722c1.766,0,2.796-1.214,2.906-3.016h4.01
            		c-0.184,4.341-2.906,6.658-6.953,6.658c-3.789,0-6.585-2.575-6.585-6.401c0-3.973,2.98-6.769,7.394-6.769h13.611
            		c4.598,0,8.093-3.348,8.093-7.909c0-4.598-3.127-7.799-7.578-7.799c-4.414,0-7.946,3.237-7.946,9.123v3.863h-4.046v-3.863
            		c0-7.872,5.076-12.986,12.066-12.986c6.695,0,11.551,4.782,11.551,11.588C44.723,32.026,39.499,36.955,32.473,36.955z"/>
            </g>
            </svg>
        </a>
        <a class="header-hamburger" data-menu-trigger="toggle">
            <span class="header-hamburger__wrap">
                <span class="header-hamburger__line--top"></span>
                <span class="header-hamburger__line--middle"></span>
                <span class="header-hamburger__line--bottom"></span>
                <span class="header-hamburger__line--arrow-top"></span>
                <span class="header-hamburger__line--arrow-bottom"></span>
            </span>
        </a>
        <ul class="header-nav">
            <li><a href="http://docs.parseplatform.org">Docs</a></li>
            <li><a class="active" href="/">Blog</a></li>
        </ul>
	</div><!-- container -->
</header>

            <aside class="hero hero--docs-landing">
    <div class="grid-container">
        <div class="col--9">
            <div class="hero--docs-landing__content">
                
                
                <div>
    <span class="author">Naitik Shah -</span>
    <span class="date">
        June
        
        23rd,
          
        2014
    </span>
</div>

                <h1 class="h1 h1--white">
                    dvara: A Mongo Proxy
                </h1>
            </div>
        </div>
    </div>
</aside><!-- .hero -->
<div class="container padding-top-40 padding-bottom-50" data-nav-waypoint>
    <article role="article" class="posts">
        
        <div>
    
    <a href="/blog/categories/engineering" class="btn btn--dark--outline btn--xsmall category">Engineering</a>
    
</div>

        <div class="padding-bottom-20 padding-top-20">
  
  
</div>
        <div class="padding-bottom-40 post"><p>We wrote <a href="https://github.com/facebookgo/dvara" title="dvara">dvara</a>, a connection pooling proxy for mongo, to solve an immediate problem we were facing. We were running into the connection limits on some of our replica sets. Mongo through 2.4 had a <a href="https://github.com/mongodb/mongo/blob/v2.4/src/mongo/util/net/listen.h#L27" title="Mongo 2.4 Max Max Conn">max-max conn limit of 20,000</a>. As the number of our application servers grew, the number of concurrent active connections to our replica sets grew. Mongo 2.6 <a href="https://github.com/mongodb/mongo/blob/master/src/mongo/util/net/listen.h#L43" title="Mongo 2.6 removed Max Max Conn">removed</a> this limit, but it was unfortunately not ready at that time (we’re still testing it and haven’t upgraded to it yet). Even if it were ready, the <a href="https://github.com/mongodb/mongo/blob/master/src/mongo/util/net/message_server_port.cpp#L92" title="Mongo Per-Connection Overhead">cost per connection is 1MB</a>, which takes away precious memory otherwise used by the database. A sharded cluster with <code class="highlighter-rouge">mongos</code> as the proxy was another path we considered. Enabling sharding may have helped, but that change would spill over into our application logic and we use at least some of the <a href="http://docs.mongodb.org/manual/reference/limits/#limits-sharding-operations" title="Mongo Sharding Operational Restrictions">restricted features</a>. We are experimenting with sharded replica sets in our environment, and from our experience we weren’t confident they would actually help with our connection limit problem. So we set out on what seemed like an ambitious, and in my mind, a difficult goal of building a connection pooling proxy for <code class="highlighter-rouge">mongod</code>.</p>

<p><strong>Down to the Wire</strong></p>

<p>We started off with a simple proof of concept, working backwards from <a href="http://docs.mongodb.org/meta-driver/latest/legacy/mongodb-wire-protocol/" title="Legacy Mongo Wire Protocol">legacy wire protocol documentation</a>. We got it far enough to serve basic read/write queries in a few weeks. We attribute the speed at which we got the prototype working to using <a href="http://golang.org/" title="The Go Programming Language">Go</a> to build it. Go allowed us to write easy to follow code, and yet not pay the cost of a thread per connection, or the alternative of having to write callbacks or some other form of manually managed asynchronous network IO logic. Additionally, while our proxy prefers to not look at the bytes flowing through or decode the BSON for performance reasons, <a href="http://labix.org/" title="Gustavo Niemeyer">Gustavo Niemeyer</a>’s excellent <a href="http://labix.org/mgo" title="mgo: Mongo Go Driver">mgo</a> driver, along with its <code class="highlighter-rouge">bson</code> library made it trivial for us to introspect and mutate the traffic we needed to. The first of these cases was the <a href="http://docs.mongodb.org/manual/reference/command/isMaster/" title="Mongo isMaster Command">isMaster</a> and the <a href="http://docs.mongodb.org/manual/reference/command/replSetGetStatus/" title="Mongo replSetGetStatus Command">replSetGetStatus</a> commands. These command return the member/host information the client uses to decide who to connect and talk to. We need to replace the real host/ports with the proxy host/ports.</p>

<p>Yet another command that needed special handling, and one of the known problems we had to solve was to handle the way Mongo 2.4 and earlier require a second follow up call for <a href="http://docs.mongodb.org/manual/reference/command/getLastError/" title="Mongo getLastError Command">getLastError</a>. Fortunately this got some much needed love in 2.6, but until 2.4 mutation operations were essentially split into two parts: first, the mutation itself; and second, the <code class="highlighter-rouge">getLastError</code> command which included some important options, including the <a href="http://docs.mongodb.org/manual/core/write-concern/" title="Mongo Write Concern">write concern</a>. Consider what a connection pooling proxy does: a client sends a command, we take a connection from our pool, proxy the command and the response, and put the connection back into the pool for someone else to use. A good proxy would hold a connection from the pool for the least amount of time possible. Unfortunately the design of <code class="highlighter-rouge">getLastError</code> means we can’t do that, because <code class="highlighter-rouge">getLastError</code> is <em>state that exists in mongod per-connection</em>. This design is awkward enough that it actually requires <a href="https://github.com/mongodb/mongo/search?q=forShell" title="Mongo forShell getLastError Specialization">special logic for the mongo shell</a> to ensure it doesn’t get inadvertently reset. It was clear we’ll need to similarly maintain this state per connection in the proxy as well. Our implementation tries to preserve the semantics <code class="highlighter-rouge">mongod</code> itself has around <code class="highlighter-rouge">getLastError</code>, though once we’ve moved all our servers and clients to 2.6 this will be unnecessary with the new wire protocol.</p>

<p><strong>Proxying in Production</strong></p>

<p>An aspect we refined before we started using this in production was to auto discover replica set configuration from the nodes. At first our implementation required manual configuration that mapped each node we wanted to proxy. We always need a mapping in order to alter the responses for the <code class="highlighter-rouge">isMaster</code> and <code class="highlighter-rouge">replSetGetStatus</code> responses mentioned earlier. Our current implementation automatically configures this and uses the provided member list as a <em>seed list</em>. We’re still improving how this works, and likely will reintroduce manual overrides to support unusual situations that often arise in real life.</p>

<p>One of the benefits of <code class="highlighter-rouge">dvara</code> has been the ability to get metrics about various low level operations which were not necessarily readily available to us. We track about 20 metrics including things like number of mutation operations, number of operations with responses, latency of operations, number of concurrent connections. Our current implementation is tied to <a href="http://ganglia.sourceforge.net/" title="Ganglia Monitoring System">Ganglia</a> using our own <a href="https://github.com/facebookgo/ganglia" title="Ganglia Go Client">go client</a> but we’re working on making that pluggable.</p>

<p>We’ve been using <a href="https://github.com/facebookgo/dvara" title="dvara">dvara</a> in production for some time, but we know there are mongo failure scenarios it doesn’t handle gracefully yet. We also want a better process around deploying new versions of dvara without causing disruptions to the clients (possibly using <a href="https://github.com/facebookgo/grace" title="Graceful Restart for Go Servers">grace</a>). We want to help improve the ecosystem around mongo, and would love for you to contribute!</p>
</div>
        <div class="copy-block margin-top-40 signature">
            <div>
                <span class="author">Naitik Shah</span>
            </div>
            <div class="margin-top-20">
                
                
                
            </div>
        </div>
    </article>
</div>

        </div><!-- /.content__wrapper -->
    </div><!-- /.site__content -->
</div><!-- /.site__wrapper -->
</body>

<script>
    anchors.options = {
      placement: 'left'
    };
    anchors.add();
</script>
</html>
