<!doctype html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>MongoDB + RocksDB: Benchmark Setup &amp; Compression</title>
    <link rel="apple-touch-icon" sizes="57x57" href="/img/favicon/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/img/favicon/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/img/favicon/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/img/favicon/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/img/favicon/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/img/favicon/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/img/favicon/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/img/favicon/apple-touch-icon-180x180.png">
    <meta name="apple-mobile-web-app-title" content="Parse">
    <link rel="icon" type="image/png" href="/img/favicon/favicon-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/img/favicon/favicon-160x160.png" sizes="160x160">
    <link rel="icon" type="image/png" href="/img/favicon/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/img/favicon/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="/img/favicon/favicon-32x32.png" sizes="32x32">
    <meta name="msapplication-TileColor" content="#5298fc">
    <meta name="msapplication-TileImage" content="/img/favicon/apple-touch-icon-144x144.png">
    <meta name="application-name" content="Parse">
    <meta name="theme-color" content="#5298fc">
    <!-- CSS -->
    <!-- build:css -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.5.0/styles/default.min.css">
    <link href="/css/blog.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" rel="stylesheet" />
    <!-- endbuild -->
    <!--[if lte IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/classlist/2014.01.31/classList.min.js"></script>
    <![endif]-->
    <script src="//cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/anchor-js/3.2.2/anchor.js"></script>
    <!--[if lt IE 8]>
    <link rel="stylesheet" type="text/css" href="/stylesheets/ie7.css" />
    <![endif]-->
    <!--[if IE 8]>
    <link rel="stylesheet" type="text/css" href="/stylesheets/ie8.css" />
    <![endif]-->
    <!--[if lt IE 10]>
    <link rel="stylesheet" type="text/css" href="/stylesheets/ie89.css" />
    <![endif]-->
    <script>if(Function('/*@cc_on return document.documentMode===10@*/')()){document.documentElement.className+=' ie10';}</script>
    <meta name="csrf-param" content="authenticity_token">
    <meta name="csrf-token" content="KxDoKysxiXDIRV8VXwDYlQStDGzjbGZ24y6ZgQLYAsE=">
    <meta name="description" content="The best place to stay up-to-date with the latest Parse news and events.
">
    <meta name="keywords" content="backend, mobile, development, server, code">
    <meta property="fb:app_id" content="361736430535656">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Parse">
    <meta property="og:image" content="http://blog.parseplatform.org//assets/images/social.jpg">
    <meta property="og:description" content="The best place to stay up-to-date with the latest Parse news and events.
">
    <meta property="og:url" content="http://blog.parseplatform.org//learn/engineering/mongodb-rocksdb-benchmark-setup-compression/">
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body class="pure p_docs p_docs_index  user_logged_in">
<div class="site__wrapper">
    <div class="site__content">
        <div class="content__wrapper">
            <header class="site__header site__header--white">
    <div class="container">
        <a href="/" class="header-logo">
            <span class="hidden">Parse</span>
            <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
            	 viewBox="0 0 152 60" style="enable-background:new 0 0 152 60;" xml:space="preserve">
            <g>
            	<path class="line one" d="M23.072,39.678c-0.011,3.348-2.395,4.615-4.909,4.615c-2.851,0-4.541-1.701-4.541-4.357
            		c0-2.964,2.031-4.667,5.35-4.725h13.611c6.428,0.079,10.137-5.391,10.137-9.953c0-4.598-3.485-9.598-9.622-9.842
            		c-6.083-0.242-9.99,5.281-9.99,11.167v3.863"/>
            	<path class="line two" d="M23.072,39.678c-0.011,3.348-2.395,4.615-4.909,4.615c-2.851,0-4.541-1.701-4.541-4.357
            		c0-2.964,2.031-4.667,5.35-4.725h13.611c6.428,0.079,10.137-5.391,10.137-9.953c0-4.598-3.485-9.598-9.622-9.842
            		c-6.083-0.242-9.99,5.281-9.99,11.167v3.863"/>
            	<path class="line three" d="M23.072,39.678c-0.011,3.348-2.395,4.615-4.909,4.615c-2.851,0-4.541-1.701-4.541-4.357
            		c0-2.964,2.031-4.667,5.35-4.725h13.611c6.428,0.079,10.137-5.391,10.137-9.953c0-4.598-3.485-9.598-9.622-9.842
            		c-6.083-0.242-9.99,5.281-9.99,11.167v3.863"/>
            	<path class="st1" d="M151.88,31.106c0-4.561-2.575-7.835-7.173-7.872c-5.665-0.037-9.197,4.12-9.197,10.484v0.11
            		c0,6.033,3.863,9.601,9.601,9.601c1.839,0,4.083-0.405,5.739-1.177v-3.568c-1.839,0.956-3.752,1.398-5.408,1.398
            		c-3.568,0-6.07-1.803-6.18-5.959h12.36C151.807,33.056,151.88,32.026,151.88,31.106z M148.312,31.07h-8.829
            		c0.625-3.053,2.354-4.745,4.966-4.745c2.575,0,3.863,1.729,3.863,4.561V31.07z"/>
            	<path class="st1" d="M125.725,34.712l0.405,0.147c2.869,1.03,3.531,1.655,3.531,2.906c0,1.471-0.993,2.428-3.458,2.428
            		c-1.986,0-4.12-0.662-6.364-1.692v3.752c1.803,0.699,4.12,1.177,6.364,1.177c4.819,0,7.21-2.428,7.21-5.812
            		c0-2.943-1.471-4.525-5.408-5.959l-0.405-0.147c-3.127-1.14-3.752-1.655-3.752-2.869c0-1.361,0.956-2.281,3.237-2.281
            		c1.839,0,3.642,0.589,5.408,1.435v-3.531c-1.582-0.625-3.348-1.03-5.26-1.03c-4.598,0-7.1,2.575-7.1,5.886
            		C120.134,31.695,121.679,33.24,125.725,34.712"/>
            	<path class="st1" d="M110.863,29.892c1.288-2.023,3.09-3.016,5.26-3.016c0.773,0,1.508,0.11,2.17,0.331v-3.384
            		c-0.625-0.258-1.361-0.405-2.134-0.405c-2.281,0-4.01,1.03-5.518,3.09l-0.258-2.869h-3.164v19.386h3.642V29.892z"/>
            	<path class="st1" d="M96.481,23.197c-2.281,0-4.672,0.699-6.474,1.692v3.605c2.023-1.251,4.378-2.023,6.254-2.023
            		c2.612,0,3.679,1.14,3.679,3.274v1.619c-5.334,0.147-8.461,1.03-10.116,2.685c-1.177,1.14-1.692,2.685-1.692,4.267
            		c0,3.274,2.354,5.15,5.702,5.15c2.244,0,4.378-0.92,6.327-2.796l0.221,2.354h3.164V30.003
            		C103.544,25.405,101.263,23.197,96.481,23.197z M99.938,37.728c-1.471,1.619-3.2,2.722-5.297,2.722
            		c-1.729,0-2.833-0.883-2.833-2.428c0-2.281,1.876-3.642,8.13-3.826V37.728z"/>
            	<path class="st1" d="M77.609,17.643h-8.571v25.383h3.826v-8.314h4.745c5.923,0,9.491-3.164,9.491-8.498V26.14
            		C87.1,20.806,83.532,17.643,77.609,17.643z M83.311,26.214c0,3.421-1.986,5.04-5.444,5.04h-5.003V21.101h5.04
            		c3.421,0,5.408,1.619,5.408,5.04V26.214z"/>
            	<path class="st1" d="M27.838,2.192C12.204,2.192-0.12,14.589-0.12,30.15c0,15.597,12.323,27.958,27.958,27.958
            		c15.634,0,27.958-12.36,27.958-27.958C55.795,14.589,43.472,2.192,27.838,2.192z M32.473,36.955H18.752
            		c-1.986,0-3.164,1.214-3.164,3.017c0,1.582,1.067,2.722,2.612,2.722c1.766,0,2.796-1.214,2.906-3.016h4.01
            		c-0.184,4.341-2.906,6.658-6.953,6.658c-3.789,0-6.585-2.575-6.585-6.401c0-3.973,2.98-6.769,7.394-6.769h13.611
            		c4.598,0,8.093-3.348,8.093-7.909c0-4.598-3.127-7.799-7.578-7.799c-4.414,0-7.946,3.237-7.946,9.123v3.863h-4.046v-3.863
            		c0-7.872,5.076-12.986,12.066-12.986c6.695,0,11.551,4.782,11.551,11.588C44.723,32.026,39.499,36.955,32.473,36.955z"/>
            </g>
            </svg>
        </a>
        <a class="header-hamburger" data-menu-trigger="toggle">
            <span class="header-hamburger__wrap">
                <span class="header-hamburger__line--top"></span>
                <span class="header-hamburger__line--middle"></span>
                <span class="header-hamburger__line--bottom"></span>
                <span class="header-hamburger__line--arrow-top"></span>
                <span class="header-hamburger__line--arrow-bottom"></span>
            </span>
        </a>
        <ul class="header-nav">
            <li><a href="http://docs.parseplatform.org">Docs</a></li>
            <li><a class="active" href="/">Blog</a></li>
        </ul>
	</div><!-- container -->
</header>

            <aside class="hero hero--docs-landing">
    <div class="grid-container">
        <div class="col--9">
            <div class="hero--docs-landing__content">
                
                
                <div>
    <span class="author">Mike Kania -</span>
    <span class="date">
        April
        
        30th,
        
        2015
    </span>
</div>

                <h1 class="h1 h1--white">
                    MongoDB + RocksDB: Benchmark Setup &amp; Compression
                </h1>
            </div>
        </div>
    </div>
</aside><!-- .hero -->
<div class="container padding-top-40 padding-bottom-50" data-nav-waypoint>
    <article role="article" class="posts">
        
        <div>
    
    <a href="/blog/categories/engineering" class="btn btn--dark--outline btn--xsmall category">Engineering</a>
    
    <a href="/blog/categories/ops" class="btn btn--dark--outline btn--xsmall category">Ops</a>
    
</div>

        <div class="padding-bottom-20 padding-top-20">
  
  
</div>
        <div class="padding-bottom-40 post"><p>Parse has been running on MongoDB since version 1.8, so we’ve accumulated a massive amount of operational knowledge about what it takes to run a production MongoDB deployment. Running MongoDB is fairly easy operationally; however, scaling MongoDB can be challenging with things like storage inefficiencies and database-level lock contention. The new modular storage engine API in MongoDB 3.0 is like a magical wand that enables us to run MongoDB on a storage engine optimized for our workloads.</p>

<p>As we said <a href="http://blog.parse.com/announcements/mongodb-rocksdb-parse/">last week</a>, this will be the first in a series of posts where we do a deep dive into our experiences benchmarking MongoDB 3.0 with RocksDB. Parse has had the tremendous benefit of working side by side with the <a href="http://rocksdb.org/">RocksDB</a> team, who have engineered a screaming fast write-optimized storage engine that is already being used to power multiple internal Facebook services.</p>

<h2 id="benchmark-setup">Benchmark Setup</h2>

<p><a href="https://github.com/ParsePlatform/flashback">Flashback</a> is a tool we open-sourced last year to record our production workloads and replay them in an isolated environment at varying speeds. We evaluated performance using Flashback’s per-operation latency metrics. In addition, we also set up a log processing pipeline that allowed us to perform ad-hoc analysis and diagnose performance regressions. At a high level, the pipeline works by first logging every operation in MongoDB, and then parsing the log lines into JSON using <a href="https://github.com/tmc/mongologtools"><span style="text-decoration: underline;">mongologtools</span></a>. The JSON is then shipped to an internal Facebook data diving tool that we used to analyze performance in realtime.</p>

<p>To come up with a replayable production workload, we need to do two things: start capturing all operations of a replica set, and create a consistent snapshot from the start of the recorded session.</p>

<h3 id="capturing-a-workload">Capturing a workload</h3>

<p>First we need to begin capturing all the production operations for a set period of time by initiating a “record” session using Flashback. To set up a Flashback record session, we copied the config template (config.template) and modified the following stanzas:</p>

<ul class="standard-list">
  <li>
    <b>target_databases</b>: A list of all the databases you would like to record
  </li>
  <li>
    <b>oplog_server</b>: A secondary that will be used to tail the oplog for write operations
  </li>
  <li>
    <b>profiler_server</b>: The primary in the target replica set to capture profiling data
  </li>
  <li>
    <b>duration_sec:<b> </b></b>Defines how long you want to record
  </li>
</ul>

<p>We recommend setting duration_sec to a long time, like 8 to 12 hours, so you get a representative sample of your requests.</p>

<p>Next, we enabled profiling on the primary target node using the set_mongo_profiling.py script. Warning: this <strong>can</strong> impact the performance of your production replica set because it does an additional write for each operation to the profiling collection, although in practice this has generally been fine for us.</p>

<pre class="line-numbers"><code class="language-bash">./set_mongo_profiling.py -a enable -n $PRIMARY_HOSTNAME</code></pre>

<p>Now we kick off a record session using</p>

<pre class="line-numbers"><code class="language-bash">./record.py</code></pre>

<p>Once the record process has finished, there will be a large JSON file with all of the recorded operations in the order they were executed.</p>

<h3 id="creating-a-consistent-snapshot">Creating a Consistent Snapshot</h3>

<p>Around the same time you start recording operations, you need to generate a consistent backup that you can restore in your isolated test environment. Parse uses EBS snapshots, so generating an initial backup for us is as simple as locking mongod, creating an EBS snapshot of all the RAIDed volumes on /var/lib/mongodb, and unlocking mongod.</p>

<h3 id="quickly-replaying-the-same-workload">Quickly Replaying the same Workload</h3>

<p>After replaying a workload, we wanted an efficient way to roll back to a consistent state. We could restore back to the snapshotted EBS volumes each time, but this is very time-consuming because you also need to warm up the EBS volumes and pull the blocks down from S3 for each fresh run. This can take hours or days if you have terabytes of data.</p>

<p>With that in mind, we decided to use LVM on top of EBS to provide a copy-on-write restore point that can be easily rolled back. Although this will incur a small amount of I/O overhead, we can now replay the same workload multiple times quickly and easily. As part of our production provisioning process, we create the logical volumes on top of the RAIDed set of EBS volumes.</p>

<pre class="line-numbers"><code class="language-bash">#/dev/md0 is the EBS RAID
pvcreate /dev/md0
vgcreate mongovg /dev/md0
lvcreate -l 90%%VG -n mongoraid mongovg</code></pre>

<p>When restoring from backup in our test environment, we define a restore point:</p>

<pre class="line-numbers"><code class="language-bash">lvcreate -l 10%VG -s -n restore_point /dev/mongovg/mongoraid</code></pre>

<p>After finishing a benchmark, we stop mongod, unmount the filesystem and merge the copy-on-write logical volume to rollback to a consistent state:</p>

<pre class="line-numbers"><code class="language-bash">lvconvert --merge /dev/mongovg/restore_point</code></pre>

<p>It’s a simple wash, rinse, and repeat to replay the same workload with different tuning parameters.</p>

<h2 id="benchmarking-multiple-storage-engines">Benchmarking Multiple Storage Engines</h2>

<p>Normally when we run Flashback benchmarks, we can just restore from backup and replay our captured workload over and over. However in MongoDB 3.0, each storage engine has a different on-disk format. So we also need to run an initial sync of each new storage engine against our restored MMAPv1 backup, and then run benchmarks on each format.</p>

<h3 id="storage-engine-efficiency-results">Storage engine efficiency results</h3>

<p>We ran an initial sync on 3.0MMAPv1, RocksDB and WiredTiger from our production backup. This particular replica set contained approximately 150 databases and 370k collections. Both WiredTiger and RocksDB had compression enabled using Snappy. The test hosts ran on EC2. We used r3.4xlarge instances with 6TB of EBS storage and 6000 provisioned IOPS.</p>

<p><img class="aligncenter wp-image-3498 size-content-full" src="http://blog.parseplatform.org//assets/wp-content/uploads/2015/04/mongo3.0-storage-efficiency-875x496.png" alt="mongo3.0-storage-efficiency" width="640" height="363" srcset="http://blog.parseplatform.org//assets/wp-content/uploads/2015/04/mongo3.0-storage-efficiency-875x496.png 875w, http://blog.parseplatform.org//assets/wp-content/uploads/2015/04/mongo3.0-storage-efficiency-300x170.png 300w, http://blog.parseplatform.org//assets/wp-content/uploads/2015/04/mongo3.0-storage-efficiency.png 939w" sizes="(max-width: 640px) 100vw, 640px" /></p>

<p>After the initial sync, RocksDB and WiredTiger cut storage used by more than 10x when compared to MMAPv1, which is pretty insane. Roughly half of the entire data set can now fit in memory (144GB). So for both WiredTiger and RocksDB, an operation that would normally require a disk read in MMAPv1 is more likely to be a simple memory lookup.</p>

<h2 id="next-steps">Next Steps</h2>

<p>After getting over the shock and delight of potentially saving <strong>10x</strong> on our storage costs, we wanted to focus on operational latencies and throughput. The second post in this series will be out next week with results of the benchmarking runs broken down by query type.</p>
</div>
        <div class="copy-block margin-top-40 signature">
            <div>
                <span class="author">Mike Kania</span>
            </div>
            <div class="margin-top-20">
                
                
                
            </div>
        </div>
    </article>
</div>

        </div><!-- /.content__wrapper -->
    </div><!-- /.site__content -->
</div><!-- /.site__wrapper -->
</body>

<script>
    anchors.options = {
      placement: 'left'
    };
    anchors.add();
</script>
</html>
